<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turkey Redistricter (Fixed)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f8fafc; --panel: #ffffff; --ink: #0f172a; --muted: #64748b;
      --border: #e2e8f0; --brand: #2563eb; --brand-hov: #1d4ed8;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--ink); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* Navbar */
    .navbar { height: 56px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 500; }
    .brand { font-weight: 800; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .nav-center { display: flex; background: #f1f5f9; padding: 3px; border-radius: 6px; }
    .mode-btn { border: none; background: transparent; padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; }
    .mode-btn.active { background: white; color: var(--brand); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    /* Layout */
    .viewport { flex: 1; display: flex; position: relative; }
    #map { flex: 1; background: #eef2f6; outline: none; }
    
    /* Sidebar */
    .sidebar { width: 360px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; box-shadow: -4px 0 20px rgba(0,0,0,0.02); }
    .sb-head { padding: 14px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .sb-body { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
    
    /* Components */
    .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: white; font-weight: 600; font-size: 12px; cursor: pointer; }
    .btn-primary { background: var(--brand); color: white; border-color: var(--brand); }
    .btn-primary:hover { background: var(--brand-hov); }
    
    select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-family: inherit; font-size: 13px; }

    /* Seat Cards */
    .seat-card { display: grid; grid-template-columns: 20px 1fr auto; gap: 10px; align-items: center; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: 0.1s; background: white; }
    .seat-card:hover { border-color: #cbd5e1; }
    .seat-card.active { border-color: var(--brand); background: #eff6ff; box-shadow: 0 0 0 1px var(--brand); }
    .color-dot { width: 20px; height: 20px; border-radius: 5px; border: 1px solid rgba(0,0,0,0.1); }
    .seat-meta { font-size: 11px; color: var(--muted); }
    .seat-win { font-weight: 700; font-size: 11px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.05); }

    /* Loader */
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    
    /* Tooltip */
    .tooltip { position: absolute; background: rgba(255,255,255,0.98); padding: 10px; border-radius: 8px; border: 1px solid var(--border); box-shadow: var(--shadow); font-size: 12px; pointer-events: none; z-index: 1000; display: none; min-width: 180px; }
    .tt-row { display: flex; justify-content: space-between; margin-top: 4px; }
    .tt-mute { color: var(--muted); }
    .tt-val { font-family: monospace; font-weight: 600; }
  </style>
</head>
<body>

  <div id="loader">
    <div style="font-weight:800; font-size:18px; color:var(--brand)">Loading Map Data...</div>
    <div style="font-size:13px; color:var(--muted); margin-top:6px">Filtering points & matching districts</div>
  </div>

  <nav class="navbar">
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l6-3 6 3 6-3v13l-6 3-6-3-6 3V7z" stroke-linejoin="round"/></svg>
      <span>Turkey Redistricter</span>
    </div>
    <div class="nav-center">
      <button class="mode-btn active" id="btnView">Data View</button>
      <button class="mode-btn" id="btnDraw">Map Drawer</button>
    </div>
    <button class="btn" id="btnExport">Export JSON</button>
  </nav>

  <div class="viewport">
    <div id="map">
      <div id="tooltip" class="tooltip"></div>
    </div>

    <aside class="sidebar">
      
      <div id="panelView" style="display:flex; flex-direction:column; height:100%">
        <div class="sb-head">District Data</div>
        <div class="sb-body">
          <label style="font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase">Metric</label>
          <select id="metricSelect">
            <option value="election">2024 Election Winner</option>
            <option value="pop">Population (2024)</option>
            <option value="popChange">Population Change (10yr)</option>
          </select>
          
          <div id="selInfo" style="margin-top:20px; display:none">
            <div style="font-size:18px; font-weight:800" id="infName">District</div>
            <div style="font-size:13px; color:var(--muted)" id="infProv">Province</div>
            <div style="height:1px; background:var(--border); margin:12px 0"></div>
            <div class="tt-row"><span>Population</span> <span class="tt-val" id="infPop">0</span></div>
            <div class="tt-row"><span>Winner</span> <span class="tt-val" id="infWin">—</span></div>
            <div class="tt-row"><span>Votes</span> <span class="tt-val" id="infVote">0</span></div>
          </div>
          <div id="selHint" style="margin-top:20px; text-align:center; color:var(--muted); font-size:12px">Hover over a district</div>
        </div>
      </div>

      <div id="panelDraw" style="display:none; flex-direction:column; height:100%">
        <div class="sb-head">
          <span>Seats</span>
          <button class="btn btn-primary" id="btnAddSeat">+ New</button>
        </div>
        <div class="sb-body" id="seatList">
          </div>
        <div style="padding:12px; background:#f1f5f9; border-top:1px solid var(--border); font-size:11px; color:var(--muted)">
          Select a seat, then click map to assign districts.
        </div>
      </div>

    </aside>
  </div>

  <script>
    // --- Config ---
    const FILES = {
      geo: 'turkey-admin-level-6.geojson',
      csv: 'province_district_2014_2019_2024.csv',
      elec_istanbul: 'İstanbul.json' // User provided file
    };

    const COLORS = {
      "AK PARTİ": "#ffbf00", "CHP": "#e30000", "MHP": "#8b0000", "İYİ PARTİ": "#3db5e6", 
      "DEM PARTİ": "#b400ff", "YEŞİL SOL": "#b400ff", "TİP": "#c70000", 
      "ZAFER": "#2c2c2c", "YENİDEN REFAH": "#008000", "MEMLEKET": "#0055aa"
    };

    const PALETTE = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4"];

    // --- State ---
    let map, geoLayer;
    let districtData = new Map(); // key -> { pop, votes, ... }
    let seats = [];
    let assignment = new Map(); // key -> seatId
    let activeSeat = null;
    let mode = 'view';

    // --- Aggressive Normalizer for Turkish Keys ---
    function keyify(str) {
      if(!str) return "";
      let s = String(str).trim();
      // Explicit Turkish Replacements before normalization
      s = s.replace(/İ/g, "i").replace(/I/g, "i").replace(/ı/g, "i")
           .replace(/Ş/g, "s").replace(/ş/g, "s")
           .replace(/Ğ/g, "g").replace(/ğ/g, "g")
           .replace(/Ü/g, "u").replace(/ü/g, "u")
           .replace(/Ö/g, "o").replace(/ö/g, "o")
           .replace(/Ç/g, "c").replace(/ç/g, "c");
      // Remove accents and non-alphanumeric
      return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
              .toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    // --- Init ---
    window.onload = async () => {
      initMap();
      setupUI();
      try {
        await loadData();
      } catch(e) {
        alert("Error loading data: " + e.message);
      }
      document.getElementById('loader').style.display = 'none';
    };

    function initMap() {
      map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([39, 35], 6);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    }

    async function loadData() {
      // 1. Fetch
      const [geoRes, csvRes, istRes] = await Promise.all([
        fetch(FILES.geo).then(r => r.json()),
        d3.csv(FILES.csv),
        fetch(FILES.elec_istanbul).then(r => r.ok ? r.json() : [])
      ]);

      // 2. Index CSV Population
      const popMap = {};
      csvRes.forEach(row => {
        const prov = row.Province || row.province || row.PROVINCE;
        const dist = row.District || row.district || row.DISTRICT;
        const key = keyify(prov) + "|" + keyify(dist);
        popMap[key] = {
          p14: +row['2014']?.replace(/,/g,'') || 0,
          p24: +row['2024']?.replace(/,/g,'') || 0
        };
      });

      // 3. Index Election Data (Istanbul + placeholders)
      const elecMap = {};
      
      const processElecRow = (row, provName) => {
        const distName = row["İlçe Adı"] || row["Ilçe Adı"];
        if(!distName) return;
        const key = keyify(provName) + "|" + keyify(distName);
        
        let votes = {};
        let total = 0;
        let maxV = 0;
        let winner = "—";

        Object.keys(row).forEach(k => {
          if(["İlçe Adı", "İlçe Id", "Sandık", "Seçmen", "Kullanılan", "Geçerli"].some(x => k.includes(x))) return;
          const val = +String(row[k]).replace(/\./g,'');
          if(!isNaN(val) && val > 0) {
            votes[k] = val;
            total += val;
            if(val > maxV) { maxV = val; winner = k; }
          }
        });
        elecMap[key] = { winner, votes, total };
      };

      // Process Istanbul file
      if(Array.isArray(istRes)) {
        istRes.forEach(row => processElecRow(row, "Istanbul"));
      }

      // 4. Bind to Map Features
      geoLayer = L.geoJSON(geoRes, {
        // !!! FIX: Filter out "Point" geometries (Tacks) !!!
        filter: (feature) => {
          return feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon";
        },
        style: styleFn,
        onEachFeature: onEachFeature
      }).addTo(map);

      // 5. Build final data lookup from map features
      geoLayer.eachLayer(layer => {
        const p = layer.feature.properties;
        // Try multiple property fields for name
        const dName = p.name || p.DISTRICT || "";
        // Try to guess province from network "TR-34" or admin_level_4
        let provName = p.province || "";
        if(!provName && p.network) {
          // Simple map for demo purposes, usually you need a lookup
          if(p.network.includes("TR-34")) provName = "Istanbul";
          if(p.network.includes("TR-06")) provName = "Ankara";
        }

        const key = keyify(provName) + "|" + keyify(dName);
        // Fallback key if province is missing (just dist name)
        const keySimple = "|" + keyify(dName); 

        // Try exact match, then simple match
        const pop = popMap[key] || popMap[keySimple] || { p14:0, p24:0 };
        const elec = elecMap[key] || elecMap[keySimple] || { winner: "N/A", votes:{}, total:0 };

        districtData.set(L.stamp(layer), {
          name: dName,
          prov: provName,
          pop,
          elec,
          key
        });
      });

      map.fitBounds(geoLayer.getBounds());
    }

    // --- Styling ---
    function styleFn(feature) {
      const id = L.stamp(feature); // Leaflet internal ID is stable here because layer is created
      // If feature isn't added yet, L.stamp might be null. 
      // Workaround: We style based on interaction in real-time usually, 
      // but for initial load, we might need a simpler lookup or rely on update.
      return {
        fillColor: '#e2e8f0',
        color: 'white',
        weight: 0.5,
        fillOpacity: 0.8
      };
    }

    function updateMapStyle() {
      geoLayer.eachLayer(layer => {
        const id = L.stamp(layer);
        const d = districtData.get(id);
        const seatId = assignment.get(id);

        let fc = '#f1f5f9';
        let fo = 0.8;
        let border = 'white';

        if(mode === 'draw') {
          if(seatId) {
            const s = seats.find(x => x.id === seatId);
            if(s) { fc = s.color; fo = 0.9; }
          }
        } else {
          // View Mode
          if(d) {
            const m = document.getElementById('metricSelect').value;
            if(m === 'election') {
               const w = d.elec.winner;
               if(w && w !== "N/A" && w !== "—") {
                 // Try to match partial keys
                 const k = Object.keys(COLORS).find(c => w.includes(c));
                 fc = k ? COLORS[k] : '#94a3b8';
               }
            } else if (m === 'pop') {
               fc = d.pop.p24 > 300000 ? '#064e3b' : d.pop.p24 > 100000 ? '#10b981' : d.pop.p24 > 50000 ? '#6ee7b7' : '#d1fae5';
            } else {
               const chg = d.pop.p24 - d.pop.p14;
               fc = chg > 0 ? '#10b981' : '#ef4444';
            }
          }
        }

        layer.setStyle({ fillColor: fc, fillOpacity: fo, color: border });
      });
    }

    // --- Interactions ---
    function onEachFeature(feature, layer) {
      layer.on('mouseover', (e) => {
        const d = districtData.get(L.stamp(layer));
        if(!d) return;

        // Tooltip
        const tt = document.getElementById('tooltip');
        tt.style.display = 'block';
        tt.style.left = (e.originalEvent.pageX + 15) + 'px';
        tt.style.top = (e.originalEvent.pageY + 15) + 'px';
        tt.innerHTML = `<div style="font-weight:700">${d.name}</div><div class="tt-mute">${d.prov}</div>`;

        // Panel Info
        if(mode === 'view') {
          document.getElementById('selInfo').style.display = 'block';
          document.getElementById('selHint').style.display = 'none';
          document.getElementById('infName').innerText = d.name;
          document.getElementById('infProv').innerText = d.prov;
          document.getElementById('infPop').innerText = d.pop.p24.toLocaleString();
          document.getElementById('infWin').innerText = d.elec.winner;
          document.getElementById('infWin').style.color = COLORS[d.elec.winner] || 'black';
          document.getElementById('infVote').innerText = d.elec.total.toLocaleString();
        }

        layer.setStyle({ weight: 2, color: '#333' });
      });

      layer.on('mouseout', (e) => {
        document.getElementById('tooltip').style.display = 'none';
        layer.setStyle({ weight: 0.5, color: 'white' });
      });

      layer.on('click', (e) => {
        if(mode === 'draw' && activeSeat) {
          const id = L.stamp(layer);
          const curr = assignment.get(id);
          
          if(curr === activeSeat) {
            assignment.delete(id);
          } else {
            assignment.set(id, activeSeat);
          }
          
          recalcSeats();
          updateMapStyle();
        }
      });
    }

    // --- Seat Logic ---
    function recalcSeats() {
      seats.forEach(seat => {
        seat.pop = 0;
        let aggVotes = {};
        
        // Find all layers assigned to this seat
        for(const [lid, sid] of assignment.entries()) {
          if(sid === seat.id) {
            const d = districtData.get(lid);
            if(d) {
              seat.pop += d.pop.p24;
              // Sum votes
              Object.entries(d.elec.votes).forEach(([p, v]) => {
                aggVotes[p] = (aggVotes[p] || 0) + v;
              });
            }
          }
        }

        // Determine winner
        let max = 0; seat.winner = "—";
        Object.entries(aggVotes).forEach(([p,v]) => {
          if(v > max) { max = v; seat.winner = p; }
        });
      });
      renderSeats();
    }

    function renderSeats() {
      const el = document.getElementById('seatList');
      el.innerHTML = '';
      seats.forEach(s => {
        const div = document.createElement('div');
        div.className = `seat-card ${activeSeat === s.id ? 'active' : ''}`;
        div.innerHTML = `
          <div class="color-dot" style="background:${s.color}"></div>
          <div>
             <div style="font-weight:700; font-size:13px">${s.name}</div>
             <div class="seat-meta">Pop: ${s.pop.toLocaleString()}</div>
          </div>
          <div class="seat-win" style="color:${COLORS[s.winner]||'#666'}">${s.winner}</div>
        `;
        div.onclick = () => { activeSeat = s.id; renderSeats(); };
        el.appendChild(div);
      });
    }

    // --- UI Wiring ---
    function setupUI() {
      document.getElementById('btnView').onclick = () => setMode('view');
      document.getElementById('btnDraw').onclick = () => setMode('draw');
      document.getElementById('metricSelect').onchange = updateMapStyle;
      
      document.getElementById('btnAddSeat').onclick = () => {
        const id = Date.now();
        seats.push({
          id,
          name: "Seat " + (seats.length+1),
          color: PALETTE[seats.length % PALETTE.length],
          pop: 0,
          winner: "—"
        });
        activeSeat = id;
        recalcSeats();
      };

      document.getElementById('btnExport').onclick = () => {
         const out = seats.map(s => ({
           name: s.name,
           pop: s.pop,
           winner: s.winner,
           districts: [...assignment.entries()].filter(([k,v]) => v === s.id).map(([k,v]) => districtData.get(k).name)
         }));
         const blob = new Blob([JSON.stringify(out,null,2)], {type : 'application/json'});
         const a = document.createElement('a');
         a.href = URL.createObjectURL(blob);
         a.download = 'turkey_plan.json';
         a.click();
      };
    }

    function setMode(m) {
      mode = m;
      document.getElementById('btnView').className = m === 'view' ? 'mode-btn active' : 'mode-btn';
      document.getElementById('btnDraw').className = m === 'draw' ? 'mode-btn active' : 'mode-btn';
      document.getElementById('panelView').style.display = m === 'view' ? 'flex' : 'none';
      document.getElementById('panelDraw').style.display = m === 'draw' ? 'flex' : 'none';
      updateMapStyle();
    }

  </script>
</body>
</html>
