<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turkey Redistricter</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- d3 (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:#eaf2ff;
      background:
        radial-gradient(1200px 900px at 18% 8%, rgba(103,232,249,.18), transparent 62%),
        radial-gradient(1000px 800px at 78% 14%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 700px at 50% 92%, rgba(34,211,238,.10), transparent 62%),
        linear-gradient(180deg,#070a10 0%, #04060a 100%);
      overflow:hidden;
    }

    :root{
      --panel: rgba(12,16,26,.60);
      --panel2: rgba(9,12,18,.72);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.16);
      --text: #eaf2ff;
      --muted: rgba(226,238,255,.68);
      --muted2: rgba(226,238,255,.50);
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 14px 34px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;

      --aqua: #67e8f9;
      --violet:#a78bfa;
      --rose: #ff4d6d;
      --gold: #ffd166;
      --ink:  #060812;
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(8,10,14,.82), rgba(6,7,10,.55));
      backdrop-filter: blur(16px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .mark{
      width:36px;height:36px;border-radius:14px;
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14), 0 18px 50px rgba(103,232,249,.15);
      position:relative;overflow:hidden;
    }
    .mark:before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 45%);
      transform: rotate(18deg);
    }
    .mark:after{
      content:"";
      position:absolute; inset:8px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(0,0,0,.34), rgba(0,0,0,.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    }

    .brandText{display:flex;flex-direction:column;gap:2px}
    .title{
      font-weight:900;letter-spacing:.2px;font-size:14px;
      display:flex;align-items:center;gap:10px;
    }
    .sub{
      font-size:12px;color:var(--muted2);
    }
    .tag{
      font-size:11px;font-weight:800;
      padding:4px 10px;border-radius:999px;
      color: rgba(0,0,0,.88);
      background: linear-gradient(135deg, rgba(103,232,249,.95), rgba(167,139,250,.95));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14);
    }

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .ctl{display:flex;flex-direction:column;gap:6px;min-width:170px}
    .ctl span{
      font-size:11px;color:var(--muted2);
      text-transform:uppercase;letter-spacing:.16px;
    }

    .selectWrap{position:relative}
    select{
      appearance:none;
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      color: var(--text);
      border:1px solid var(--border);
      border-radius: 13px;
      padding:10px 38px 10px 12px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      transition: border-color .15s ease, transform .15s ease;
    }
    .selectWrap:after{
      content:"";
      position:absolute;right:12px;top:50%;
      width:10px;height:10px;
      border-right:2px solid rgba(255,255,255,.65);
      border-bottom:2px solid rgba(255,255,255,.65);
      transform: translateY(-65%) rotate(45deg);
      pointer-events:none;
    }
    select:hover{border-color: var(--border2)}
    select:focus{border-color: rgba(103,232,249,.42)}

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      color: var(--text);
      padding:10px 12px;
      border-radius: 13px;
      cursor:pointer;
      transition: transform .12s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 16px 34px rgba(0,0,0,.18);
      display:inline-flex;align-items:center;gap:8px;
      font-weight:800;
    }
    .btn:hover{transform: translateY(-1px);border-color:var(--border2);box-shadow:0 20px 46px rgba(0,0,0,.22)}
    .btn:active{transform: translateY(0)}
    .btn-ghost{background:transparent;box-shadow:none}
    .btn-ghost:hover{background:rgba(255,255,255,.06);box-shadow:none}

    .ico{width:16px;height:16px;display:inline-block;opacity:.92}

    /* ===== Layout ===== */
    .wrap{
      height: calc(100vh - 68px);
      display:grid;
      grid-template-columns: 1fr 392px;
      gap: 14px;
      padding: 14px;
    }

    #map{
      height:100%;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative;
      background: #05070b;
    }
    #map:before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), inset 0 0 120px rgba(103,232,249,.06);
      border-radius: var(--radius);
      z-index: 5;
    }

    .sidebar{
      height:100%;
      overflow:auto;
      padding-right:6px;
      display:flex;flex-direction:column;gap:12px;
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .cardTitle{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .pill{
      font-size:11px;font-weight:800;
      padding:4px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
    }
    .cardBody{padding:12px 14px}

    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

    /* ===== Legend ===== */
    .legend{display:flex;flex-direction:column;gap:10px}
    .legendItem{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      transition: transform .12s ease, border-color .15s ease;
    }
    .legendItem:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.14)}
    .swatch{
      width:16px;height:16px;border-radius:7px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .legendLabel{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;width:100%;
    }
    .legendLabel b{font-weight:900}
    .legendLabel span{color:var(--muted2);font-size:12px}

    .gradWrap{
      padding:12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
    }
    .gradBar{
      height:18px;border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 14px 34px rgba(0,0,0,.25);
      overflow:hidden;
      background: linear-gradient(90deg, #0b1220, #67e8f9);
    }
    .gradBar.div{
      background: linear-gradient(90deg, #ff4d6d, #0b1220, #67e8f9);
    }
    .gradMeta{
      display:flex;justify-content:space-between;gap:10px;
      margin-top:10px;
      color: var(--muted2);
      font-size:12px;
    }

    /* ===== District inspector ===== */
    .headline{
      font-size:14px;font-weight:900;letter-spacing:.2px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .subline{margin-top:2px;color:var(--muted2);font-size:12px}

    .kvs{display:grid;grid-template-columns:1fr auto;gap:8px 12px;margin-top:10px}
    .k{color:var(--muted2);font-size:12px}
    .v{font-weight:900}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .winnerDot{
      width:10px;height:10px;border-radius:999px;
      box-shadow: 0 0 0 1px rgba(255,255,255,.18), 0 10px 18px rgba(0,0,0,.25);
    }

    .bars{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .barRow{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
    }
    .barName{font-size:12px;font-weight:900}
    .barTrack{
      height:10px;border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.22);
    }
    .barFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(103,232,249,.92), rgba(167,139,250,.85));
    }
    .barVal{font-size:12px;color:var(--muted2);white-space:nowrap}

    /* ===== Loading curtain (only at startup) ===== */
    .curtain{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(900px 700px at 50% 30%, rgba(103,232,249,.10), transparent 65%),
                  linear-gradient(180deg, rgba(6,7,10,.92), rgba(4,5,7,.92));
      z-index: 999;
      transition: opacity .28s ease, visibility .28s ease;
    }
    .curtain.hide{opacity:0; visibility:hidden; pointer-events:none}
    .loaderCard{
      width:min(520px, 92vw);
      border-radius: 22px;
      padding: 16px 16px 18px;
      background: linear-gradient(180deg, rgba(12,16,26,.78), rgba(8,10,14,.82));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      backdrop-filter: blur(20px);
    }
    .loaderTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.10);
    }
    .loaderTop .left{display:flex; align-items:center; gap:12px}
    .spinner{
      width:18px; height:18px; border-radius:999px;
      border:2px solid rgba(255,255,255,.22);
      border-top-color: rgba(103,232,249,.92);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loaderTitle{font-weight:900; letter-spacing:.2px}
    .loaderBody{margin-top:10px; color: var(--muted)}
    .loaderHint{margin-top:8px; color: var(--muted2); font-size:12px}

    /* ===== Dialog ===== */
    dialog{
      width:min(760px, 92vw);
      border:none;
      border-radius: 22px;
      padding:0;
      background: linear-gradient(180deg, rgba(12,16,26,.92), rgba(8,10,14,.86));
      color: var(--text);
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      overflow:hidden;
    }
    dialog::backdrop{background: rgba(0,0,0,.66)}
    .dlgHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      font-weight:900;
    }
    .dlgBody{padding:14px 16px}
    code{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 8px;
      border-radius: 10px;
    }

    /* Leaflet controls – match theme */
    .leaflet-control-zoom, .leaflet-control-attribution{
      border-radius: 14px !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      overflow:hidden !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.30);
      background: rgba(10,14,22,.55) !important;
    }
    .leaflet-control-zoom a{
      background: transparent !important;
      color: #eaf2ff !important;
      border-bottom: 1px solid rgba(255,255,255,.10) !important;
    }
    .leaflet-control-zoom a:last-child{border-bottom:none !important}
    .leaflet-control-zoom a:hover{background: rgba(255,255,255,.08) !important}
    .leaflet-control-attribution{padding: 6px 10px !important; color: rgba(234,242,255,.70) !important}

    /* Responsive */
    @media (max-width: 980px){
      body{overflow:auto}
      .wrap{grid-template-columns: 1fr; height:auto; min-height: calc(100vh - 68px)}
      #map{height: 62vh}
      .sidebar{height:auto}
    }
  </style>
</head>

<body>
  <!-- Startup loading curtain -->
  <div id="curtain" class="curtain">
    <div class="loaderCard">
      <div class="loaderTop">
        <div class="left">
          <div class="spinner"></div>
          <div class="loaderTitle">Loading Turkey districts…</div>
        </div>
        <div class="tag">v0.2</div>
      </div>
      <div id="loaderMsg" class="loaderBody">Fetching GeoJSON & population…</div>
      <div class="loaderHint">Tip: host via GitHub Pages (not <span class="mono">file://</span>) so data loads reliably.</div>
    </div>
  </div>

  <header class="topbar">
    <div class="brand">
      <div class="mark" aria-hidden="true"></div>
      <div class="brandText">
        <div class="title">Turkey Redistricter <span class="tag">clean UI</span></div>
        <div class="sub">districts • elections • population • layers</div>
      </div>
    </div>

    <div class="controls">
      <label class="ctl">
        <span>Layer</span>
        <div class="selectWrap">
          <select id="modeSelect">
            <option value="election_winner">Election: winner</option>
            <option value="election_margin">Election: margin</option>
            <option value="population_year">Population: year</option>
            <option value="population_change">Population: change</option>
          </select>
        </div>
      </label>

      <label class="ctl" id="yearWrap">
        <span>Year</span>
        <div class="selectWrap">
          <select id="yearSelect">
            <option value="2014">2014</option>
            <option value="2019">2019</option>
            <option value="2024" selected>2024</option>
          </select>
        </div>
      </label>

      <label class="ctl" id="yearAWrap">
        <span>From</span>
        <div class="selectWrap">
          <select id="yearASelect">
            <option value="2014" selected>2014</option>
            <option value="2019">2019</option>
            <option value="2024">2024</option>
          </select>
        </div>
      </label>

      <label class="ctl" id="yearBWrap">
        <span>To</span>
        <div class="selectWrap">
          <select id="yearBSelect">
            <option value="2014">2014</option>
            <option value="2019">2019</option>
            <option value="2024" selected>2024</option>
          </select>
        </div>
      </label>

      <button id="fitBtn" class="btn" title="Fit to Turkey">
        <svg class="ico" viewBox="0 0 24 24" fill="none">
          <path d="M7 3H3v4M17 3h4v4M7 21H3v-4M21 21h-4v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Fit
      </button>
      <button id="helpBtn" class="btn btn-ghost" title="Help">
        <svg class="ico" viewBox="0 0 24 24" fill="none">
          <path d="M12 18h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          <path d="M10.2 9a2 2 0 1 1 3.6 1.2c-.7.8-1.8 1.1-1.8 2.3v.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        Help
      </button>
    </div>
  </header>

  <div class="wrap">
    <div id="map"></div>

    <aside class="sidebar">
      <section class="card">
        <div class="cardHeader">
          <div class="cardTitle">Legend</div>
          <div class="pill" id="legendPill">—</div>
        </div>
        <div class="cardBody">
          <div id="legend" class="legend"></div>
        </div>
      </section>

      <section class="card">
        <div class="cardHeader">
          <div class="cardTitle">District</div>
          <div class="pill">hover</div>
        </div>
        <div class="cardBody">
          <div id="hoverBox" class="muted small">Hover a district.</div>
        </div>
      </section>
    </aside>
  </div>

  <dialog id="helpDialog">
    <div class="dlgHead">
      <div>Help</div>
      <button id="closeHelpBtn" class="btn btn-ghost">Close</button>
    </div>
    <div class="dlgBody">
      <div class="muted">
        <ul>
          <li>Loads all districts automatically.</li>
          <li>Required files in the same folder:
            <ul>
              <li><code>turkey-admin-level-6.geojson</code></li>
              <li><code>province_district_2014_2019_2024.csv</code></li>
              <li>Election JSONs: <code>Edirne.json</code>, <code>Ankara.json</code>… (missing is OK)</li>
            </ul>
          </li>
          <li>Hover a district to see population + election details.</li>
        </ul>
      </div>
    </div>
  </dialog>

  <script>
  (function(){
    "use strict";

    const FILES = {
      GEOJSON: "turkey-admin-level-6.geojson",
      POPCSV: "province_district_2014_2019_2024.csv",
    };

    const PROVINCES = [
      ["Adana", 1],["Adıyaman", 2],["Afyonkarahisar", 3],["Ağrı", 4],["Amasya", 5],["Ankara", 6],["Antalya", 7],["Artvin", 8],["Aydın", 9],["Balıkesir", 10],
      ["Bilecik", 11],["Bingöl", 12],["Bitlis", 13],["Bolu", 14],["Burdur", 15],["Bursa", 16],["Çanakkale", 17],["Çankırı", 18],["Çorum", 19],["Denizli", 20],
      ["Diyarbakır", 21],["Edirne", 22],["Elazığ", 23],["Erzincan", 24],["Erzurum", 25],["Eskişehir", 26],["Gaziantep", 27],["Giresun", 28],["Gümüşhane", 29],["Hakkâri", 30],
      ["Hatay", 31],["Isparta", 32],["Mersin", 33],["İstanbul", 34],["İzmir", 35],["Kars", 36],["Kastamonu", 37],["Kayseri", 38],["Kırklareli", 39],["Kırşehir", 40],
      ["Kocaeli", 41],["Konya", 42],["Kütahya", 43],["Malatya", 44],["Manisa", 45],["Kahramanmaraş", 46],["Mardin", 47],["Muğla", 48],["Muş", 49],["Nevşehir", 50],
      ["Niğde", 51],["Ordu", 52],["Rize", 53],["Sakarya", 54],["Samsun", 55],["Siirt", 56],["Sinop", 57],["Sivas", 58],["Tekirdağ", 59],["Tokat", 60],
      ["Trabzon", 61],["Tunceli", 62],["Şanlıurfa", 63],["Uşak", 64],["Van", 65],["Yozgat", 66],["Zonguldak", 67],["Aksaray", 68],["Bayburt", 69],["Karaman", 70],
      ["Kırıkkale", 71],["Batman", 72],["Şırnak", 73],["Bartın", 74],["Ardahan", 75],["Iğdır", 76],["Yalova", 77],["Karabük", 78],["Kilis", 79],["Osmaniye", 80],
      ["Düzce", 81],
    ];
    const plateToProvince = new Map(PROVINCES.map(([n,p]) => [p,n]));

    const PARTY_COLORS = new Map([
      ["CHP", "#e5383b"],
      ["AK PARTİ", "#f59f00"],
      ["MHP", "#9b2226"],
      ["İYİ PARTİ", "#ffd500"],
      ["YEŞİL SOL PARTİ", "#2a9d8f"],
      ["DEM PARTİ", "#2a9d8f"],
      ["TİP", "#c1121f"],
      ["ZAFER PARTİSİ", "#4361ee"],
      ["YENİDEN REFAH", "#40916c"],
      ["SAADET", "#2b9348"],
      ["DEVA", "#4cc9f0"],
      ["GELECEK", "#7209b7"],
      ["MEMLEKET", "#ef233c"],
    ]);

    // Turkish folding
    const TR_MAP = new Map([
      ["İ","I"],["I","I"],["Ş","S"],["Ğ","G"],["Ü","U"],["Ö","O"],["Ç","C"],
      ["ı","I"],["ş","S"],["ğ","G"],["ü","U"],["ö","O"],["ç","C"],
    ]);
    function trFold(s){
      if (s == null) return "";
      s = String(s).trim().replace(/\s+/g," ");
      s = Array.from(s).map(ch => TR_MAP.get(ch) ?? ch).join("");
      s = s.toUpperCase();
      s = s.replace(/[()\-,\.]/g," ").replace(/\s+/g," ").trim();
      return s;
    }
    function trAsciiName(s){
      return Array.from(String(s||"")).map(ch => TR_MAP.get(ch) ?? ch).join("").replace(/ı/g,"i");
    }
    function parseIntTR(x){
      if (x == null) return null;
      const s = String(x).trim();
      if (!s) return null;
      if (s.includes("%")) return null;
      const digits = s.replace(/[^\d]/g,"");
      if (!digits) return null;
      return Number(digits);
    }
    function clamp01(x){ return Math.max(0, Math.min(1, (x==null||Number.isNaN(x))?0:x)); }
    function formatInt(n){
      if (n == null || Number.isNaN(n)) return "—";
      return new Intl.NumberFormat("tr-TR").format(n);
    }
    function safe(v){ return (v==null || v==="") ? "—" : String(v); }

    function lerp(a,b,t){ return a + (b-a)*t; }
    function hexToRgb(hex){
      const h = hex.replace("#","");
      const full = h.length===3 ? h.split("").map(c=>c+c).join("") : h;
      return [parseInt(full.slice(0,2),16), parseInt(full.slice(2,4),16), parseInt(full.slice(4,6),16)];
    }
    function rgbToHex(r,g,b){
      const to = (x)=>x.toString(16).padStart(2,"0");
      return `#${to(r)}${to(g)}${to(b)}`;
    }
    function mixHex(a,b,t){
      const [ar,ag,ab]=hexToRgb(a), [br,bg,bb]=hexToRgb(b);
      return rgbToHex(Math.round(lerp(ar,br,t)), Math.round(lerp(ag,bg,t)), Math.round(lerp(ab,bb,t)));
    }
    function hashColor(str){
      let h=0;
      for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i))>>>0;
      const r = 80 + (h & 0x7f);
      const g = 80 + ((h>>8) & 0x7f);
      const b = 80 + ((h>>16) & 0x7f);
      return rgbToHex(r,g,b);
    }
    function colorForParty(name){
      if (!name) return "rgba(255,255,255,.08)";
      const clean = String(name).trim();
      return PARTY_COLORS.get(clean) ?? hashColor(clean);
    }

    // Robust URL resolution
    function resolveUrl(rel){ return new URL(rel, window.location.href).toString(); }
    async function fetchText(rel){
      const url = resolveUrl(rel);
      const resp = await fetch(url, { cache:"no-store" });
      if (!resp.ok) throw new Error(`${rel} -> HTTP ${resp.status}`);
      return await resp.text();
    }
    async function fetchJson(rel){ return JSON.parse(await fetchText(rel)); }
    async function fetchCsv(rel){ return d3.csvParse(await fetchText(rel)); }

    function parsePlateFromNetwork(network){
      const m = String(network ?? "").match(/TR(\d{2})-districts/i);
      if (!m) return null;
      return Number(m[1]);
    }
    function uniqueKey(plate, distKey){ return `${plate}|${distKey}`; }

    // UI refs
    const el = {};
    function grabEls(){
      el.modeSelect = document.getElementById("modeSelect");
      el.yearSelect = document.getElementById("yearSelect");
      el.yearASelect = document.getElementById("yearASelect");
      el.yearBSelect = document.getElementById("yearBSelect");
      el.yearWrap = document.getElementById("yearWrap");
      el.yearAWrap = document.getElementById("yearAWrap");
      el.yearBWrap = document.getElementById("yearBWrap");
      el.legend = document.getElementById("legend");
      el.legendPill = document.getElementById("legendPill");
      el.hoverBox = document.getElementById("hoverBox");
      el.fitBtn = document.getElementById("fitBtn");
      el.helpBtn = document.getElementById("helpBtn");
      el.helpDialog = document.getElementById("helpDialog");
      el.closeHelpBtn = document.getElementById("closeHelpBtn");
      el.curtain = document.getElementById("curtain");
      el.loaderMsg = document.getElementById("loaderMsg");
    }

    // State
    const state = {
      pop: null, // {provKey: {distKey: {2014,2019,2024}}}
      elections: new Map(), // uk -> row
      districtData: new Map(), // uk -> joined
      mode: "election_winner",
      year: 2024,
      yearA: 2014,
      yearB: 2024,
    };

    // Map
    let map, districtLayer, canvasRenderer;

    function initMap(){
      map = L.map("map", { zoomControl: true, preferCanvas: true }).setView([39.0, 35.0], 6);

      // Dark basemap, no key
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
      }).addTo(map);

      canvasRenderer = L.canvas({ padding: 0.5 });

      districtLayer = L.geoJSON([], {
        renderer: canvasRenderer,
        style: featureStyle,
        onEachFeature: onEachDistrict,
      }).addTo(map);
    }

    function featureStyle(feature){
      const base = colorForFeature(feature);
      return {
        color: "rgba(255,255,255,.18)",
        weight: 0.9,
        opacity: 1,
        fillColor: base,
        fillOpacity: 0.72,
      };
    }

    function onEachDistrict(feature, layer){
      layer.on({
        mouseover: () => {
          layer.setStyle({
            weight: 2.2,
            color: "rgba(255,255,255,.86)",
            fillOpacity: 0.84
          });
          updateHover(feature);
        },
        mouseout: () => {
          districtLayer.resetStyle(layer);
          el.hoverBox.innerHTML = `<div class="muted small">Hover a district.</div>`;
        }
      });
    }

    // Elections
    function parseElectionRows(rows){
      const clean = [];
      if (!Array.isArray(rows)) return clean;

      for (const r of rows){
        const idRaw = (r["İlçe Id"] ?? r["Ilçe Id"] ?? r["Ilce Id"] ?? r["İLÇE ID"]);
        const idStr = String(idRaw ?? "").trim();
        if (!/^\d+$/.test(idStr)) continue;

        const row = { ...r };
        row.__district = (r["İlçe Adı"] ?? r["Ilçe Adı"] ?? r["Ilce Adı"] ?? r["İlçe Adi"] ?? "").toString().trim();
        row.__distKey = trFold(row.__district);

        row.__registered = parseIntTR(r["Kayıtlı Seçmen Sayısı"]);
        row.__cast = parseIntTR(r["Oy Kullanan Seçmen Sayısı"]);
        row.__valid = parseIntTR(r["Geçerli Oy Toplamı"]);

        const partyVotes = [];
        for (const [k, v] of Object.entries(r)){
          const kk = String(k).trim();
          if (!kk) continue;
          if (["İlçe Id","İlçe Adı","Belde Adı","Kayıtlı Seçmen Sayısı","Oy Kullanan Seçmen Sayısı","Geçerli Oy Toplamı"].includes(kk)) continue;
          const votes = parseIntTR(v);
          if (votes == null) continue;
          partyVotes.push([kk.trim(), votes]);
        }
        partyVotes.sort((a,b)=>b[1]-a[1]);
        row.__partyVotes = partyVotes;

        const winner = partyVotes[0]?.[0] ?? null;
        const winnerVotes = partyVotes[0]?.[1] ?? null;
        const runnerVotes = partyVotes[1]?.[1] ?? null;

        row.__winner = winner;
        row.__winnerVotes = winnerVotes;
        row.__runner = partyVotes[1]?.[0] ?? null;
        row.__marginVotes = (winnerVotes!=null && runnerVotes!=null) ? (winnerVotes - runnerVotes) : null;
        row.__marginShare = (row.__valid && row.__marginVotes!=null) ? (row.__marginVotes / row.__valid) : null;

        clean.push(row);
      }
      return clean;
    }

    async function tryFetchElectionJson(provName, plate){
      const candidates = [
        `${provName}.json`,
        `${trAsciiName(provName)}.json`,
        `${plate}.json`,
      ];
      for (const rel of candidates){
        try{
          const url = resolveUrl(rel);
          const resp = await fetch(url, { cache:"no-store" });
          if (!resp.ok) continue;
          return await resp.json();
        }catch(_){}
      }
      return null;
    }

    async function loadAllElections(){
      const queue = PROVINCES.map(([name, plate]) => ({name, plate}));
      const concurrency = 8;

      async function worker(){
        while (queue.length){
          const job = queue.shift();
          const raw = await tryFetchElectionJson(job.name, job.plate);
          if (raw){
            const parsed = parseElectionRows(raw);
            for (const row of parsed){
              const uk = uniqueKey(job.plate, row.__distKey);
              state.elections.set(uk, row);
            }
          }
        }
      }

      await Promise.all(Array.from({length: concurrency}, worker));
    }

    function rebuildDistrictDataIndex(){
      state.districtData.clear();
      districtLayer.eachLayer(layer => {
        const f = layer.feature;
        const p = f.properties || {};
        const uk = p.__uk;

        const pop = state.pop?.[p.__provKey]?.[p.__distKey] ?? null;
        const election = state.elections.get(uk) ?? null;

        state.districtData.set(uk, {
          feature: f,
          pop,
          election,
          provName: p.__provName,
          distName: p.__distName,
        });
      });
    }

    // Coloring
    function numericColor(val, kind){
      if (val==null || Number.isNaN(val)) return "rgba(255,255,255,.06)";

      const values = [];
      for (const j of state.districtData.values()){
        if (state.mode === "population_year"){
          const v = j.pop?.[state.year];
          if (v!=null) values.push(v);
        } else if (state.mode === "population_change"){
          const a=j.pop?.[state.yearA], b=j.pop?.[state.yearB];
          if (a!=null && b!=null) values.push(b-a);
        }
      }
      if (!values.length) return "rgba(255,255,255,.06)";
      values.sort((a,b)=>a-b);
      const min = values[0], max = values[values.length-1];
      if (min === max) return "#67e8f9";

      if (kind === "seq"){
        const t = (val - min) / (max - min);
        // elegant cold gradient on dark
        return mixHex("#0b1220", "#67e8f9", clamp01(t));
      } else {
        const m = Math.max(Math.abs(min), Math.abs(max));
        const t = clamp01((val + m) / (2*m));
        if (t < 0.5) return mixHex("#ff4d6d", "#0b1220", t/0.5);
        return mixHex("#0b1220", "#67e8f9", (t-0.5)/0.5);
      }
    }

    function colorForFeature(feature){
      const uk = feature.properties.__uk;
      const joined = state.districtData.get(uk);

      if (state.mode === "population_year"){
        const val = joined?.pop?.[state.year];
        return numericColor(val, "seq");
      }
      if (state.mode === "population_change"){
        const a = joined?.pop?.[state.yearA];
        const b = joined?.pop?.[state.yearB];
        const val = (a!=null && b!=null) ? (b - a) : null;
        return numericColor(val, "div");
      }

      const e = joined?.election;
      if (!e) return "rgba(255,255,255,.06)";

      if (state.mode === "election_margin"){
        const base = colorForParty(e.__winner);
        const t = clamp01((e.__marginShare ?? 0) / 0.25);
        return mixHex(base, "#070a10", 0.40 * t);
      }
      return colorForParty(e.__winner);
    }

    // Legend render
    function renderLegend(){
      el.legend.innerHTML = "";

      const pill =
        state.mode === "election_winner" ? "Election — winner" :
        state.mode === "election_margin" ? "Election — margin" :
        state.mode === "population_year" ? `Population — ${state.year}` :
        `Population — change ${state.yearA}→${state.yearB}`;

      el.legendPill.textContent = pill;

      if (state.mode === "election_winner" || state.mode === "election_margin"){
        const wins = new Map();
        for (const j of state.districtData.values()){
          const w = j.election?.__winner;
          if (!w) continue;
          wins.set(w, (wins.get(w) ?? 0) + 1);
        }

        const top = [...wins.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 12);
        if (!top.length){
          el.legend.innerHTML = `<div class="muted small">No election files loaded (or missing / misnamed).</div>`;
          return;
        }

        for (const [party, n] of top){
          const item = document.createElement("div");
          item.className = "legendItem";

          const sw = document.createElement("div");
          sw.className = "swatch";
          sw.style.background = colorForParty(party);

          const label = document.createElement("div");
          label.className = "legendLabel";
          label.innerHTML = `<b>${party}</b><span>${n} districts</span>`;

          item.appendChild(sw);
          item.appendChild(label);
          el.legend.appendChild(item);
        }

        if (state.mode === "election_margin"){
          const note = document.createElement("div");
          note.className = "muted2 small";
          note.style.marginTop = "10px";
          note.textContent = "Darker shade = larger winning margin.";
          el.legend.appendChild(note);
        }
        return;
      }

      // numeric legend
      const values = [];
      for (const j of state.districtData.values()){
        if (state.mode === "population_year"){
          const v = j.pop?.[state.year];
          if (v!=null) values.push(v);
        } else if (state.mode === "population_change"){
          const a=j.pop?.[state.yearA], b=j.pop?.[state.yearB];
          if (a!=null && b!=null) values.push(b-a);
        }
      }
      if (!values.length){
        el.legend.innerHTML = `<div class="muted small">No population matched.</div>`;
        return;
      }
      values.sort((a,b)=>a-b);
      const min = values[0], max = values[values.length-1];

      const wrap = document.createElement("div");
      wrap.className = "gradWrap";

      const bar = document.createElement("div");
      bar.className = "gradBar" + (state.mode === "population_change" ? " div" : "");
      wrap.appendChild(bar);

      const meta = document.createElement("div");
      meta.className = "gradMeta mono";
      meta.innerHTML = `<div>${formatInt(min)}</div><div>${formatInt(max)}</div>`;
      wrap.appendChild(meta);

      el.legend.appendChild(wrap);

      const note = document.createElement("div");
      note.className = "muted2 small";
      note.style.marginTop = "10px";
      note.textContent = state.mode === "population_change"
        ? "Left = decrease, right = increase."
        : "Right = higher population.";
      el.legend.appendChild(note);
    }

    // Hover panel
    function updateHover(feature){
      const uk = feature.properties.__uk;
      const joined = state.districtData.get(uk);

      const provName = joined?.provName ?? "—";
      const distName = joined?.distName ?? "—";
      const pop = joined?.pop;
      const e = joined?.election;

      let html = `
        <div class="headline">
          <div>${distName}</div>
        </div>
        <div class="subline">${provName}</div>
        <div class="sep"></div>
      `;

      html += `<div class="muted2 small" style="text-transform:uppercase;letter-spacing:.16px">Population</div>`;
      if (pop){
        html += `
          <div class="kvs">
            <div class="k">2014</div><div class="v mono">${formatInt(pop[2014])}</div>
            <div class="k">2019</div><div class="v mono">${formatInt(pop[2019])}</div>
            <div class="k">2024</div><div class="v mono">${formatInt(pop[2024])}</div>
          </div>
          <div class="chipRow">
            ${
              state.mode === "population_change"
                ? (() => {
                    const a = pop[state.yearA], b = pop[state.yearB];
                    const delta = (a!=null && b!=null) ? (b-a) : null;
                    return `<span class="chip"><span class="mono">Δ</span>${state.yearA}→${state.yearB}: <b>${formatInt(delta)}</b></span>`;
                  })()
                : `<span class="chip">Selected <span class="mono">${state.year}</span>: <b>${formatInt(pop[state.year])}</b></span>`
            }
          </div>
        `;
      } else {
        html += `<div class="muted small" style="margin-top:8px">—</div>`;
      }

      html += `<div class="sep"></div>`;
      html += `<div class="muted2 small" style="text-transform:uppercase;letter-spacing:.16px">Election</div>`;

      if (e){
        const winnerColor = colorForParty(e.__winner);
        const valid = e.__valid ?? null;

        html += `
          <div class="chipRow" style="margin-top:10px">
            <span class="chip">
              <span class="winnerDot" style="background:${winnerColor}"></span>
              Winner: <b>${safe(e.__winner)}</b>
              <span class="mono">(${formatInt(e.__winnerVotes)})</span>
            </span>
            ${e.__marginVotes!=null ? `<span class="chip">Margin: <b>${formatInt(e.__marginVotes)}</b> <span class="mono">${(100*(e.__marginShare??0)).toFixed(1)}%</span></span>` : ``}
          </div>

          <div class="kvs" style="margin-top:10px">
            <div class="k">Registered</div><div class="v mono">${formatInt(e.__registered)}</div>
            <div class="k">Cast</div><div class="v mono">${formatInt(e.__cast)}</div>
            <div class="k">Valid</div><div class="v mono">${formatInt(e.__valid)}</div>
          </div>
        `;

        // Top party bars (up to 5)
        const top = (e.__partyVotes ?? []).slice(0, 5);
        if (top.length && valid){
          html += `<div class="sep"></div><div class="muted2 small" style="text-transform:uppercase;letter-spacing:.16px">Top parties</div>`;
          html += `<div class="bars">`;
          for (const [party, votes] of top){
            const share = valid ? (votes/valid) : 0;
            const c = colorForParty(party);
            html += `
              <div class="barRow">
                <div class="barName">${party}</div>
                <div class="barTrack">
                  <div class="barFill" style="width:${(100*share).toFixed(1)}%; background: linear-gradient(90deg, ${c}, rgba(167,139,250,.72));"></div>
                </div>
                <div class="barVal mono">${(100*share).toFixed(1)}%</div>
              </div>
            `;
          }
          html += `</div>`;
        }
      } else {
        html += `<div class="muted small" style="margin-top:10px">No election match for this district.</div>`;
      }

      el.hoverBox.innerHTML = html;
    }

    // UI logic
    function renderModeYearVisibility(){
      const showChange = (state.mode === "population_change");
      el.yearWrap.style.display = showChange ? "none" : "flex";
      el.yearAWrap.style.display = showChange ? "flex" : "none";
      el.yearBWrap.style.display = showChange ? "flex" : "none";
    }

    function wireUI(){
      el.modeSelect.addEventListener("change", () => {
        state.mode = el.modeSelect.value;
        renderModeYearVisibility();
        districtLayer.setStyle(featureStyle);
        renderLegend();
      });

      el.yearSelect.addEventListener("change", () => {
        state.year = Number(el.yearSelect.value);
        districtLayer.setStyle(featureStyle);
        renderLegend();
      });

      el.yearASelect.addEventListener("change", () => {
        state.yearA = Number(el.yearASelect.value);
        districtLayer.setStyle(featureStyle);
        renderLegend();
      });

      el.yearBSelect.addEventListener("change", () => {
        state.yearB = Number(el.yearBSelect.value);
        districtLayer.setStyle(featureStyle);
        renderLegend();
      });

      el.fitBtn.addEventListener("click", () => {
        try{ map.fitBounds(districtLayer.getBounds(), { padding:[18,18] }); }catch(_){}
      });

      el.helpBtn.addEventListener("click", () => el.helpDialog.showModal());
      el.closeHelpBtn.addEventListener("click", () => el.helpDialog.close());

      renderModeYearVisibility();
    }

    // Load all
    async function loadAll(){
      el.loaderMsg.textContent = "Fetching GeoJSON & population…";
      const [geo, popRows] = await Promise.all([
        fetchJson(FILES.GEOJSON),
        fetchCsv(FILES.POPCSV),
      ]);

      // population index
      const pop = {};
      for (const row of popRows){
        const prov = trFold(row.Province ?? row.province ?? row.PROVINCE);
        const dist = trFold(row.District ?? row.district ?? row.DISTRICT);
        if (!prov || !dist) continue;
        pop[prov] ??= {};
        pop[prov][dist] = {
          2014: parseIntTR(row["2014"]),
          2019: parseIntTR(row["2019"]),
          2024: parseIntTR(row["2024"]),
        };
      }
      state.pop = pop;

      // features
      const features = (geo.features || [])
        .filter(f => (f.properties?.admin_level === "6" || f.properties?.admin_level === 6))
        .map(f => {
          const plate = parsePlateFromNetwork(f.properties?.network);
          const provName = plateToProvince.get(plate) ?? "Unknown";
          const provKey = trFold(provName);
          const distName = f.properties?.name ?? "";
          const distKey = trFold(distName);
          const uk = uniqueKey(plate ?? 0, distKey);
          return {
            ...f,
            properties: {
              ...f.properties,
              __plate: plate,
              __provName: provName,
              __provKey: provKey,
              __distName: distName,
              __distKey: distKey,
              __uk: uk,
            }
          };
        });

      districtLayer.clearLayers();
      districtLayer.addData(features);

      // join base
      rebuildDistrictDataIndex();
      districtLayer.setStyle(featureStyle);

      try{ map.fitBounds(districtLayer.getBounds(), { padding:[18,18] }); }catch(_){}

      renderLegend();

      // load elections
      el.loaderMsg.textContent = "Loading election files (missing files are OK)…";
      await loadAllElections();

      rebuildDistrictDataIndex();
      districtLayer.setStyle(featureStyle);
      renderLegend();

      // done
      el.curtain.classList.add("hide");
    }

    window.addEventListener("DOMContentLoaded", async () => {
      grabEls();
      initMap();
      wireUI();

      try{
        await loadAll();
      }catch(err){
        console.error(err);
        el.loaderMsg.textContent = `Fatal: ${err.message}`;
        // leave curtain up if something goes wrong
      }
    });

  })();
  </script>
</body>
</html>
